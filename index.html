<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Hlllc 敬拜曲庫</title>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    /* 全局設置：基礎字體稍大 */
    body { font-family: 'Inter', sans-serif; padding: 20px; background-color: #f7f9fc; font-size: 1.1rem; /* 基礎字體增大 */ }
    
    /* NEW: 標題和選單按鈕容器 */
    .header-container {
        display: flex;
        align-items: center;
        justify-content: space-between; /* Space out title and button */
        margin-bottom: 20px;
        
        position: sticky;
        top: 0;
        z-index: 11; /* 確保在最頂層 */
        background-color: #f7f9fc;
        padding-top: 5px; 
    }
    
    h1 { 
        color: #2c3e50; 
        border-bottom: 2px solid #54bbcd; 
        padding-bottom: 10px; 
        font-size: 1.8rem; /* 標題字體 (目標大小) */ 
        margin: 0; /* 移除 h1 預設 margin */
        width: auto; /* 讓 h1 根據內容自動調整寬度 */
        flex-shrink: 1;
        padding-right: 15px; /* 與按鈕保持間距 */
    }
    .menu-toggle-btn {
        /* [調整 1] 放大字體到標題大小 */
        font-size: 1.8rem; 
        padding: 10px 15px; /* 增大 padding */
        margin-left: 10px;
        flex-shrink: 0;
        align-self: flex-start; /* 確保按鈕貼齊頂部 */
    }
    
    /* Controls Area Styling - Added Sticky Position */
    .controls {
        /* [調整 3] 移除 flex 佈局，改為區塊化控制 */
        /* display: flex; */
        /* align-items: center; */
        gap: 10px; 
        /* flex-wrap: wrap; */
        
        position: sticky; 
        top: 0; /* 貼齊 header-container 的底部 */
        z-index: 10; 
        background-color: #f7f9fc; 
        padding-top: 10px; 
        padding-bottom: 10px; 
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* [調整 3b] 按鈕容器置中 */
    .controls-button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center; /* 置中顯示 */
        margin-top: 10px;
    }


    /* Selected Display Area Styling */
    .selected-display {
        background-color: #e0f7fa; 
        border: 1px solid #54bbcd;
        padding: 15px; /* 增大內邊距 */
        margin-bottom: 20px;
        border-radius: 0 0 8px 8px; 
        
        /* 變動 1a: 允許內容換行，移除水平滾動 */
        overflow-x: hidden; 
        white-space: normal; 
        
        font-size: 1.5rem; /* 增大已選歌曲字體 */

        position: sticky;
        transition: top 0.3s ease-in-out; /* 動態 top 值的平滑過渡 */
        z-index: 9; 
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-top: none; 
        
        /* 保持 flex 佈局以對齊標題和列表，但在小螢幕上可能會切換到 column */
        display: flex; 
        align-items: flex-start;
    }
    .selected-display-title {
        margin: 0;
        line-height: 1.5;
        flex-shrink: 0; 
    }
    .selected-song-list {
        gap: 0; 
        padding-left: 15px;
    }
    .selected-song-item {
        display: block;
        margin-bottom: 5px; 
        padding: 5px 0;
    }
    .selected-song-item label {
        display: inline;
    }
    .selected-song-item input[type="checkbox"] {
        transform: scale(1.8); 
        accent-color: #54bbcd; 
        flex-shrink: 0;
        min-width: 30px; 
        min-height: 30px;
        margin-right: 10px; 
    }

    /* 搜尋欄位字體增大 */
    input[type="text"] {
        /* [調整 2] 寬度改為 75% */
        width: 75%; 
        min-width: 300px; /* 確保桌面仍有最小寬度 */
        padding: 15px 20px; /* 增大輸入框觸控區 */
        border: 1px solid #ccc;
        border-radius: 8px;
        transition: border-color 0.3s;
        font-size: 1.6rem; /* 增大字體，接近標題 */
        display: block; /* 確保獨佔一行 */
        margin: 0 auto 15px auto; /* 置中並增加底部間距 */
    }
    input[type="text"]:focus {
        border-color: #54bbcd;
        outline: none;
    }
    
    /* 按鈕字體增大 */
    button {
        /* [調整 1c] 統一按鈕字體大小 */
        font-size: 1.8rem; 
        padding: 15px 24px; /* 增大按鈕觸控區 */
        background-color: #54bbcd;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s, transform 0.1s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        min-width: 100px;
        height: auto; 
    }
    button:hover {
        background-color: #43a3b2;
    }
    
    /* 隱藏按鈕的特殊樣式 */
    .btn-hidden {
        background-color: #bdc3c7; 
    }
    .btn-hidden:hover {
        background-color: #aeb4b8;
    }


    /* 播放/關閉影片按鈕樣式 */
    .play-video-btn, .close-video-btn {
        background-color: #2ecc71; 
        padding: 12px 20px; 
        font-size: 1.5rem; 
        box-shadow: none;
        transform: none;
        margin: 5px 0;
        width: 100%;
        min-width: auto;
    }
    .close-video-btn {
        background-color: #e74c3c; 
    }
    
    /* Video Container for 16:9 aspect ratio in Table View */
    .video-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; 
        height: 0;
        margin: 5px 0;
    }
    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    
    /* Table Styling */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0; 
        table-layout: fixed; 
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        overflow: hidden; 
        font-size: 1.3rem; 
    }
    th, td {
        border: 1px solid #e0e0e0;
        padding: 16px 12px; 
        text-align: center;
        vertical-align: middle;
        word-break: break-word;
        min-height: 60px; 
        height: auto;
    }
    thead th {
        background-color: #f1f1f1;
        color: #333;
        font-weight: 600;
        font-size: 1.4rem; 
    }

    /* Column Widths */
    th.select, td.select { 
        width: 60px; 
        min-width: 60px; 
        max-width: 60px; 
    }
    th.youtube, td.youtube { width: 19%; }
    th.sheet, td.sheet { width: 19%; }
    th.lyrics, td.lyrics { width: 40%; } 
    th.name, td.name { 
        width: 19%; 
        background-color: #f7f7f7; 
        text-align: left; 
    }
    
    /* 確保歌詞換行和靠左對齊 */
    td.lyrics {
        white-space: pre-wrap; 
        text-align: left;      
    }
    
    /* --- 調整歌名和歌譜內容字體大小 (接近 H1 標題) --- */
    td.name span, 
    td.sheet a {
        font-size: 1.5rem; 
        font-weight: bold;
    }

    /* Interactive Styles */
    td.select input[type="checkbox"] {
        margin: 0 auto;
        display: block;
        transform: scale(1.8); 
        accent-color: #54bbcd;
        min-width: 30px; 
        min-height: 30px;
    }
    .selected-row {
        background-color: #c9eaf0 !important;
        transition: background-color 0.3s;
    }
    
    a {
        color: #0077b6;
        text-decoration: none;
    }
    a:hover {
        text-decoration: underline;
    }
    
    /* --- 直式排版樣式 (Vertical Layout) --- */
    .vertical-layout-container {
        padding: 10px;
    }
    .song-card {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 25px; 
        margin-bottom: 30px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    .song-title {
        color: #2c3e50;
        font-size: 2.0rem; 
        margin-top: 0;
        margin-bottom: 15px;
        border-bottom: 2px solid #54bbcd;
        padding-bottom: 5px;
        word-break: break-all;
    }
    .section-block {
        margin-top: 25px; 
        padding-top: 10px;
        border-top: 1px dashed #eee;
    }
    .section-block h3 {
        color: #54bbcd;
        font-size: 1.6rem; 
        margin-bottom: 10px;
        display: inline-block; 
        margin-right: 15px;
    }
    .lyrics-block p {
        white-space: pre-wrap; 
        text-align: left;
        line-height: 1.8; 
        font-size: 1.5rem; 
        transition: font-size 0.2s; 
    }
    /* 垂直排版用的全寬影片容器 */
    .video-container-full {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; 
        height: 0;
        margin: 10px 0;
    }
    .video-container-full iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 8px;
    }

    /* 調整字體大小按鈕樣式 */
    .font-size-btn {
        background-color: #f39c12; 
        padding: 12px 18px; 
        font-size: 1.5rem; 
        font-weight: normal;
        margin-left: 8px; 
        line-height: 1;
        box-shadow: none;
        min-width: 50px; 
        min-height: 50px; 
        transition: background-color 0.3s;
    }
    .font-size-btn:hover {
        background-color: #e67e22;
    }

    /* New: Container for the embedded PDF viewer */
    .pdf-viewer-container {
        width: 100%;
        padding-bottom: 141.4%; 
        position: relative; 
        
        border: 1px solid #ccc;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 10px;
        background-color: white; 
    }
    .pdf-viewer-container iframe {
        position: absolute; 
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }

    /* Responsive adjustment for small screens (Mobile First Enhancement) */
    @media (max-width: 768px) {
        body { 
            padding: 10px; 
            font-size: 1.2rem; /* 基礎字體再放大 */
        }
        
        /* 標題和選單按鈕 */
        .header-container { margin-bottom: 10px; }
        h1 { padding-bottom: 5px; }
        .menu-toggle-btn { font-size: 1.6rem; padding: 10px 15px; } /* 修正手機字體 */

        /* 搜尋輸入框 */
        input[type="text"] { 
            width: 95%; /* 手機上讓它佔滿寬度 */
            min-width: 95%;
            font-size: 1.6rem; 
        }

        /* 控制按鈕區塊 */
        .controls { 
            padding-bottom: 5px; 
            /* 保持原有的 sticky 設置 */
        }
        .controls-button-group {
            justify-content: space-around; /* 在手機上分散對齊 */
        }
        button { 
            font-size: 1.4rem; /* 按鈕手機字體 */
            padding: 15px 10px; 
            min-width: auto; 
            flex-grow: 1; /* 讓按鈕平均分配空間 */
            margin-bottom: 5px;
        } 

        /* 重新計算 Sticky Header Top */
        /* 由於佈局已經改變，這裡需要重新評估貼齊高度 */
        .selected-display {
            top: 250px; /* 估計值：header(50) + controls(180) + padding */
            border-radius: 0;
            flex-direction: column; 
            font-size: 1.6rem; 
        }
        .selected-display-title {
            font-size: 1.7rem;
        }
        .selected-song-list {
            display: block; 
            padding-left: 0;
            margin-top: 5px;
        }
        .selected-song-item {
            font-size: 1.6rem;
        }
        
        /* 直式排版文字/標題 */
        .song-title { font-size: 2.2rem; }
        .section-block h3 { font-size: 1.8rem; }
        
        /* 字體調整按鈕在小螢幕上維持大尺寸 */
        .font-size-btn {
            padding: 15px 20px; 
            font-size: 1.5rem; 
        }
        .play-video-btn, .close-video-btn {
            font-size: 1.5rem; 
            padding: 18px;
        }
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="header-container">
      <h1>Hlllc 敬拜曲庫</h1>
      <!-- [調整 1b] 調整按鈕樣式類別 -->
      <button @click="showControls = !showControls" class="menu-toggle-btn button">
          {{ showControls ? '隱藏選單' : '顯示選單' }}
      </button>
    </div>
    
    <!-- [調整 3] 移除 controls 的 flex 樣式，並調整內容佈局 -->
    <div class="controls" v-show="showControls">
        <!-- [調整 2] 搜尋欄位寬度 75%，已置中 -->
        <input type="text" v-model="search" placeholder="輸入歌名關鍵字" />

        <!-- [調整 3b] 按鈕容器，用於置中和水平排列 -->
        <div class="controls-button-group">
            <!-- 新增直式排版/切換回表格 按鈕 -->
            <button 
              v-if="selectedSongsSorted.length > 0"
              @click="isVerticalLayout = !isVerticalLayout" 
              :class="{ 'btn-hidden': !isVerticalLayout }"
            >
              <!-- [調整 4] 按鈕文字 -->
              {{ isVerticalLayout ? '表格排版' : '直式排版' }}
            </button>
            
            <!-- YouTube 顯示/隱藏按鈕 -->
            <button @click="showYoutube = !showYoutube" :class="{ 'btn-hidden': !showYoutube }">
              <!-- [調整 4] 按鈕文字 -->
              {{ showYoutube ? '隱藏 YouTube' : 'YouTube' }}
            </button>
            
            <!-- 歌譜連結 顯示/隱藏按鈕 -->
            <button @click="showSheet = !showSheet" :class="{ 'btn-hidden': !showSheet }">
              <!-- [調整 4] 按鈕文字 -->
              {{ showSheet ? '隱藏歌譜' : '歌譜' }}
            </button>
            
            <!-- 歌詞顯示/隱藏按鈕 -->
            <button @click="toggleLyrics" :class="{ 'btn-hidden': !showLyrics }">
              <!-- [調整 4] 按鈕文字 -->
              {{ showLyrics ? '隱藏歌詞' : '歌詞' }}
            </button>
        </div>
    </div>
    
    <!-- 已選歌曲顯示區塊 (Sticky 第二層) -->
    <div 
        v-if="selectedSongsSorted.length" 
        class="selected-display" 
        v-show="showControls" 
        :style="{ top: selectedDisplayTop }"
    >
        <!-- 標題 -->
        <p class="selected-display-title"><strong>已選歌曲（按選取順序）：</strong></p>
        
        <!-- 歌曲清單 (可取消勾選) -->
        <div class="selected-song-list">
            <span v-for="song in selectedSongsSorted" :key="song['歌名']" class="selected-song-item">
                <input 
                    type="checkbox" 
                    :checked="true" 
                    @change="toggleSongSelection(song['歌名'], false)" 
                    :id="'sel-' + song['歌名']"
                />
                <label :for="'sel-' + song['歌名']">
                    {{ formatSelectedSongName(song.formattedName) }}
                </label>
            </span>
        </div>
    </div>

    <!-- 表格排版 (預設) -->
    <table v-show="!isVerticalLayout">
      <thead>
        <tr>
          <th class="select">選擇</th>
          <!-- 動態計算歌名欄寬度 -->
          <th class="name" :style="{ width: nameColumnWidth }">歌名</th>
          <th class="youtube" v-if="showYoutube">YouTube</th>
          <th class="sheet" v-if="showSheet">歌譜</th>
          <th class="lyrics" v-if="showLyrics">歌詞</th>
        </tr>
      </thead>
      <tbody>
        <!-- 修正 2: 處理 filteredSongs 為空的情況，避免沒有 <tbody> 內容而導致的問題 -->
        <tr v-if="filteredSongs.length === 0">
            <td :colspan="5 - (!showYoutube ? 1 : 0) - (!showSheet ? 1 : 0) - (!showLyrics ? 1 : 0)">查無資料</td>
        </tr>
        <tr v-for="song in filteredSongs" :key="song['歌名']" :class="{ 'selected-row': selectedKeys[song['歌名']] }">
          <td class="select">
            <input 
              type="checkbox" 
              :checked="!!selectedKeys[song['歌名']]"
              @change="toggleSongSelection(song['歌名'], $event.target.checked)"
            />
          </td>
          <!-- 動態計算歌名欄寬度 -->
          <td class="name" :style="{ width: nameColumnWidth }">
            <!-- 移除 NEW 標籤 -->
            <span v-html="formatTitle(song['歌名'])"></span>
          </td>
          
          <!-- YouTube 欄位 (條件顯示) -->
          <td class="youtube" v-if="showYoutube">
            <div v-if="song['YouTube']">
                <!-- 影片播放中 -->
                <template v-if="activeVideoName === song['歌名']">
                    <div class="video-container">
                        <iframe 
                            :src="getYoutubeEmbedUrl(song['YouTube'])" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                        ></iframe>
                    </div>
                    <button @click="toggleVideo(song['歌名'])" class="close-video-btn">關閉</button>
                </template>
                
                <!-- 影片未播放 -->
                <button v-else @click="toggleVideo(song['歌名'])" class="play-video-btn">
                    播放
                </button>
            </div>
            <span v-else>-</span>
          </td>
          
          <!-- 歌譜連結欄位 (條件顯示) -->
          <td class="sheet" v-if="showSheet">
            <a v-if="sheetMap[song['歌名'].trim()]" :href="sheetMap[song['歌名'].trim()]" target="_blank">
              下載
            </a>
            <span v-else>-</span>
          </td>
          
          <td class="lyrics" v-if="showLyrics">{{ song['歌詞'] }}</td>
        </tr>
      </tbody>
    </table>
    
    <!-- 移除單獨的「查無資料」段落，改在表格內部處理 -->
    

    
    <!-- 直式排版 (僅顯示已選歌曲) -->
    <!-- 修正 2: 移除直式排版的 filteredSongs.length 判斷，避免鎖定 -->
    <div v-else-if="isVerticalLayout">
        <!-- 修正 3: 如果直式排版下沒有選取歌曲，給予提示 -->
        <p v-if="selectedSongsSorted.length === 0">請先在表格模式中選取歌曲。</p>
        
        <div v-for="(song, index) in selectedSongsSorted" :key="song['歌名']" class="vertical-layout-container">
            <div class="song-card">
            <h2 class="song-title">
                <!-- 顯示選取順序 -->
                <span style="color: #54bbcd;">#{{ index + 1 }}</span>
                &nbsp;
                <!-- 修正 3a: 將 v-html 替換為直接顯示，並使用 formatSelectedSongName 處理格式 -->
                {{ formatSelectedSongName(song.formattedName) }}
            </h2>

            <!-- YouTube (Conditional Display) -->
            <div v-if="showYoutube && song['YouTube']" class="section-block">
                <h3>YouTube 影片</h3>
                <template v-if="activeVideoName === song['歌名']">
                    <div class="video-container-full">
                        <iframe 
                            :src="getYoutubeEmbedUrl(song['YouTube'])" 
                            frameborder="0" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                        ></iframe>
                    </div>
                    <button @click="toggleVideo(song['歌名'])" class="close-video-btn">關閉</button>
                </template>
                <button v-else @click="toggleVideo(song['歌名'])" class="play-video-btn">
                    播放
                </button>
            </div>

            <!-- 歌譜連結 (Conditional Display) -->
            <div v-if="showSheet && sheetMap[song['歌名'].trim()]" class="section-block">
                <h3>歌譜</h3>
                <!-- 下載連結 -->
                <a :href="sheetMap[song['歌名'].trim()]" target="_blank" style="margin-right: 20px;">
                    下載
                </a>

                <!-- 嵌入歌譜檔 (新功能: 僅在直式排版顯示) -->
                <div class="pdf-viewer-container">
                    <iframe 
                        :src="getSheetEmbedUrl(song['歌名'])" 
                        allowfullscreen="true" 
                        webkitallowfullscreen="true" 
                        mozallowfullscreen="true"
                    ></iframe>
                </div>
            </div>
            
            <!-- 歌詞 (Conditional Display) -->
            <div v-if="showLyrics && song['歌詞']" class="section-block lyrics-block">
                <!-- 歌詞標題及調整按鈕 -->
                <div style="display: flex; align-items: center;">
                    <h3>歌詞</h3>
                    <!-- 縮小按鈕 -->
                    <button 
                        @click="adjustLyricsSize(song['歌名'], -0.1)"
                        :disabled="lyricsFontSizeMap[song['歌名']] <= 0.8" 
                        class="font-size-btn"
                    >
                        A-
                    </button>
                    <!-- 放大按鈕 -->
                    <button 
                        @click="adjustLyricsSize(song['歌名'], 0.1)"
                        :disabled="lyricsFontSizeMap[song['歌名']] >= 2.0" 
                        class="font-size-btn"
                    >
                        A+
                    </button>
                </div>

                <!-- 歌詞內容 (動態字體大小) -->
                <p :style="{ 'font-size': (lyricsFontSizeMap[song['歌名']] || 1.7) + 'rem' }">
                    {{ song['歌詞'] }}
                </p>
            </div>
        </div>
        </div>
    </div>
    
    <p v-else-if="!filteredSongs.length">查無資料</p>
  </div>

  <script>
    const { createApp, watch } = Vue;

    createApp({
      data() {
        return {
          search: '',
          songs: [],
          selectedKeys: {}, 
          sheetMap: {},
          showLyrics: false, /* <--- 預設改為 false (隱藏) */
          showYoutube: true, 
          showSheet: true,   
          isVerticalLayout: false, 
          selectionOrderCounter: 0, 
          activeVideoName: null, 
          lyricsFontSizeMap: {}, 
          sheetIdMap: {}, // 新增：儲存 Google Drive 檔案 ID
          showControls: true, // NEW: 控制選單的顯示/隱藏
        };
      },
      computed: {
        filteredSongs() {
          const kw = this.search.trim().toLowerCase();
          let items = this.songs.map(song => ({
            ...song,
            _nameStripped: song['歌名'].replace(/（[^）]*）/g, ''),
            formattedName: this.formatTitle(song['歌名']) 
          }));
          if (kw) {
            items = items.filter(song => song._nameStripped.toLowerCase().includes(kw));
          }
          
          return items.sort((a, b) => a._nameStripped.localeCompare(b._nameStripped));
        },
        selectedSongsSorted() {
            const selectedSongsWithOrder = this.songs
                .filter(song => this.selectedKeys[song['歌名']])
                .map(song => ({
                    ...song,
                    order: this.selectedKeys[song['歌名']],
                    formattedName: this.formatTitle(song['歌名'])
                }));

            selectedSongsWithOrder.sort((a, b) => a.order - b.order);
            
            return selectedSongsWithOrder;
        },
        selectedSongNames() {
            return this.selectedSongsSorted
                .map(item => item.formattedName)
                .join('、 ');
        },
        nameColumnWidth() {
            if (this.isVerticalLayout) return 'auto';

            let totalFixed = 60; // 選擇欄位的固定寬度 (60px)
            let totalAvailable = document.body.clientWidth - totalFixed; 
            
            const defaultYoutubeWidth = 0.19;
            const defaultSheetWidth = 0.19;
            const defaultLyricsWidth = 0.40;
            
            let totalRemaining = 1.0; 
            
            if (this.showYoutube) {
                totalRemaining -= defaultYoutubeWidth;
            }
            if (this.showSheet) {
                totalRemaining -= defaultSheetWidth;
            }
            if (this.showLyrics) {
                totalRemaining -= defaultLyricsWidth;
            }
            
            // 由於 table-layout: fixed，歌名欄位的寬度是剩餘的百分比
            // 在 CSS 中將歌名寬度設為百分比，這裡只需要確保它足夠大
            const nameWidthPercent = totalRemaining * 100;

            if (nameWidthPercent < 5) return '5%';
            
            return `${nameWidthPercent}%`;
        },
        // NEW: 計算已選歌曲區塊的貼齊頂部位置
        selectedDisplayTop() {
            // 估計 header-container 的高度 (h1 + padding/border)
            const HEADER_HEIGHT = 65; 
            // 估計 controls 區塊在桌面/手機上的高度 (controls 內有輸入框和按鈕組)
            // 這裡採用一個近似值，實際高度會因螢幕寬度而異，但 sticky top 依靠 CSS 轉換
            const CONTROLS_HEIGHT_DESKTOP = 130; // 約 1.5rem + 1.8rem 按鈕高度 + padding
            const CONTROLS_HEIGHT_MOBILE = 250; // 手機上輸入框和按鈕組兩行疊加的高度
            
            const isMobile = window.innerWidth <= 768;
            
            if (this.showControls) {
                // 選單顯示時: 貼齊在 controls 區塊下方
                const controlsHeight = isMobile ? CONTROLS_HEIGHT_MOBILE : CONTROLS_HEIGHT_DESKTOP;
                // 這裡必須使用一個相對保守且足夠大的像素值，確保不會被遮擋
                return `${HEADER_HEIGHT + controlsHeight}px`; 
            } else {
                // 選單隱藏時: 貼齊在 header-container 下方
                return `${HEADER_HEIGHT}px`;
            }
        }
      },
      watch: {
          // 修正 1: 監聽已選歌曲數量。若在直式排版下歸零，則強制切回表格
          selectedSongsSorted(newVal) {
              if (this.isVerticalLayout && newVal.length === 0) {
                  this.isVerticalLayout = false;
                  this.activeVideoName = null;
                  // 修正：移除 focus()，改為滾動到頂部，避免移動裝置上的非預期放大
                  this.$nextTick(() => {
                      window.scrollTo(0, 0);
                  });
              }
          }
      },
      methods: {
        formatTitle(name) {
          if (!name) return '';
          
          // 1. 移除括號內的內容，作為主歌名
          let mainTitle = name.replace(/（[^）]*）/g, '').trim(); 
          
          let groupInfo = '';
          
          // 2. 提取括號內的內容
          const match = name.match(/（([^）]*)）/);
          if (match && match[1]) {
              let fullGroupInfo = match[1].trim();
              // 提取括號內第一個部分 (假設是團體名稱，即 '-' 之前的部分)
              let groupParts = fullGroupInfo.split('-');
              groupInfo = groupParts[0].trim();
          }

          // 3. 如果有團體名稱，則換行顯示，並使用 <br>
          if (groupInfo) {
             return mainTitle + '<br>' + groupInfo;
          }
          
          // 否則只顯示主歌名
          return mainTitle;
        },
        
        formatSelectedSongName(formattedName) {
            // 將 formatTitle 產生的 '<br>' 替換為 '｜'
            return formattedName.replace(/<br>/g, ' ｜ ');
        },

        toggleLyrics() {
            // 在切換歌詞顯示時，不需要重置 activeVideoName，讓影片可以繼續播放
            this.showLyrics = !this.showLyrics;
        },
        
        toggleSongSelection(songName, isSelected) {
            if (isSelected) {
                this.selectionOrderCounter++;
                // 修正 2b: 確保在選取時初始化字體大小
                this.selectedKeys = { ...this.selectedKeys, [songName]: this.selectionOrderCounter };
                if (!(songName in this.lyricsFontSizeMap)) {
                    // 預設起始字體大小改為 1.7rem (手機直式排版)
                    this.lyricsFontSizeMap = { ...this.lyricsFontSizeMap, [songName]: 1.7 };
                }
            } else {
                const newSelectedKeys = { ...this.selectedKeys };
                delete newSelectedKeys[songName];
                this.selectedKeys = newSelectedKeys;
                
                const newFontSizeMap = { ...this.lyricsFontSizeMap };
                delete newFontSizeMap[songName];
                this.lyricsFontSizeMap = newFontSizeMap;
            }
            
            if (this.isVerticalLayout) {
                // 在直式排版中，取消選中歌曲時，關閉其影片播放器
                if (!isSelected && this.activeVideoName === songName) {
                    this.activeVideoName = null;
                }
            }
        },

        adjustLyricsSize(songName, delta, reset = false) {
            // 修正 2b: 確保我們是基於當前狀態進行修改，並強制更新
            let currentSize = this.lyricsFontSizeMap[songName] || 1.7;
            let newSize;

            if (reset) {
                newSize = 1.7; /* 配合新的預設值 */
            } else {
                newSize = currentSize + delta;
            }
            
            // 保持調整範圍
            newSize = Math.max(0.8, Math.min(2.0, newSize));
            
            newSize = Math.round(newSize * 10) / 10;
            
            // 修正 2b: 確保 Vue 響應式系統能偵測到變化
            // 由於直接使用 ...this.lyricsFontSizeMap 有時仍會失效，
            // 這裡使用一個中間物件並重新賦值，以確保更新被正確追蹤。
            const updatedMap = { ...this.lyricsFontSizeMap };
            updatedMap[songName] = newSize;
            this.lyricsFontSizeMap = updatedMap;
        },
        
        toggleVideo(songName) {
            // 修復：確保即使隱藏 YouTube 欄位，點擊也不會出錯
            if (!this.showYoutube && this.isVerticalLayout) {
                // 如果在直式排版中隱藏 YouTube，強制關閉 activeVideoName
                this.activeVideoName = null;
                return;
            }
            
            if (this.activeVideoName === songName) {
                this.activeVideoName = null;
            } else {
                this.activeVideoName = songName;
            }
        },

        getYoutubeEmbedUrl(url) {
            let videoId = '';
            const watchRegex = /[?&]v=([^&]+)/;
            const shortRegex = /youtu\.be\/([^?&]+)/;

            let match = url.match(watchRegex);
            if (match && match[1]) {
                videoId = match[1];
            } else {
                match = url.match(shortRegex);
                if (match && match[1]) {
                    videoId = match[1];
                }
            }
            
            if (videoId) {
                return `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
            }
            return ''; 
        },

        // 新增：取得歌譜內嵌 URL
        getSheetEmbedUrl(songName) {
            const fileId = this.sheetIdMap[songName.trim()];
            if (fileId) {
                // 使用 Google Drive 的 /preview 路徑進行內嵌
                return `https://drive.google.com/file/d/${fileId}/preview`;
            }
            return '';
        },

        fetchSheetMap() {
          const url = 'https://script.google.com/macros/s/AKfycbwL9BcEAzQv_pYe5yC7r3lqRFIaz7Cfaqw9snBay0bgItUVbazm4PNsdT_5Cl_QEaYA/exec';
          return axios.get(url).then(resp => {
            const map = {};
            const idMap = {}; // 儲存檔案 ID
            Object.keys(resp.data).forEach(name => {
              const fileId = resp.data[name];
              map[name.trim()] = `https://drive.google.com/file/d/${fileId}`; // 下載連結
              idMap[name.trim()] = fileId; // 檔案 ID
            });
            this.sheetMap = map;
            this.sheetIdMap = idMap; // 賦值給新的狀態
          });
        }
      },
      mounted() {
        axios.get('https://opensheet.elk.sh/1fZIE67QV7fBbKonS2TzUp3kY8GPuDdG1EYDf5d1C_t8/歌曲清單')
          .then(res => {
            this.songs = res.data;
            this.selectedKeys = {}; 
            this.lyricsFontSizeMap = {}; 
          })
          .then(() => this.fetchSheetMap())
          .catch(err => console.error(err));
      }
    }).mount('#app');
  </script>
</body>
</html>
